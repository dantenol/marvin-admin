<!DOCTYPE html>
<html lang="pt" dir="ltr">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/css/master.css">
  <link rel="stylesheet" href="/css/index.css">
  <link rel="shortcut icon" href="assets/favicon.ico">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="./helper.js" charset="utf-8"></script>
  <title>Alunos</title>
  <meta http-equiv="refresh" content="30">
</head>

<body>
  <main class="vertical">
    <a class="white_back" onclick="location.href='/home.html'">
      &#11013;
    </a>
    <div id="addDialog" style="display:none">
      <div class="dialog">
        <button onclick="closeDialog()" id="closeButton">&times;</button>
        <h2>email dos alunos (um por linha)</h2>
        <textarea rows="5" name="emails" autocomplete="off"></textarea>
        <br>
        <button onclick="createStudents()" class="green">Adicionar</button>
      </div>
    </div>
    <div id="selection">
      <h3>Selecionar curso:</h3>
      <select id="courses">
        <option disabled selected value></option>
      </select>
    </div>
    <h4 id="totalCP"></h4>
    <div id="students">
      <div class="table">
        <div class="row">
          <span>Usuáro</span>
          <span>XP</span>
          <span>Fase</span>
          <span>Pontos</span>
          <span>PÂNICO</span>
          <span></span>
        </div>
      </div>
    </div>
    <button id="newStudent" onclick="newStudent()" style="display: none;">
      Novo aluno
    </button>
  </main>
  <script type="text/javascript">
  let courses;
  let course;

  $('select#courses').on('change', function() {
    loadCourse(this.value)
  });

  function loadCourse(i) {
    course = courses[i];
    const params = new URLSearchParams(location.search)
    params.set('course', i)
    window.history.pushState(0, 0, '?' + params.toString());
    $('#students .table .row').slice(1).remove();
    let CPoints = 0;
    courses[i].students.map((e, i) => {
      CPoints += e.correctionPoints;
      $('#students .table').append(
        `<div class="row">
          <div>${e.username}</div>
          <input type="text" value="${Math.round(e.XPPoints)}" size="10" id="XP${e.id}">
          <div>${e.activityNumber}</div>
          <input type="text" value="${e.correctionPoints}" size="10" id="CP${e.id}">
          <a href="#" onclick="panic('${e.id}')">
            <div class="${e.panic && "panic"}" id="panic${e.id}"></div>
          </a>
          <button onclick="save('${e.id}')">Salvar</button>
        </div>`
      );
    })
    const avg = CPoints/course.students.length;
    $('#newStudent').show();
    $('#totalCP').empty();
    $('#totalCP').append('Correção: ' + CPoints + ', média: ' + Math.round(avg * 100) / 100);
  }

  function save(id) {
    const data = {}
    const vals = $(`[id$="${id}"]`).each(function () {
       data[$(this).prop('id')[0]] = $(this).val();
    })
    delete data.p;
    data.XPPoints = data.X;
    delete data.X;
    data.correctionPoints = data.C;
    delete data.C;
    console.log(data);
    patch(id, data)
  }

  function newStudent() {
    $('#addDialog').show();
  }

  function closeDialog() {
    $("#addDialog").hide();
    $('textarea[name=emails]').val("");
  }

  function createStudents() {
    let emails = $('textarea[name=emails]').val();
    emails = emails.replace(/ /g, "");
    emails = emails.split("\n")
    let count = 0;
    emails.map(e => {
      var re = /^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i
      if (re.test(e)) {
        $.ajax({
          type: 'post',
          url: url + 'courses/' + course.id +'/students/?access_token=' + localStorage.access_token,
          crossDomain: true,
          data: {email: e, password: 'projetomarvin'},
          success: function(responseData, textStatus, jqXHR) {
            alert('Usuário ' + e + ' criado com sucesso!');
          },
          error: function(responseData, textStatus, errorThrown) {
            alert('Algo deu errado' + JSON.stringify(responseData))
          }
        })
      } else {
        alert('email ' + e + ' não é válido!');
      }
    })
  }

  function panic(id) {
    patch(id, {panic: null});
  }

  function patch(id, data) {
      $.ajax({
        type: 'patch',
        url: url + 'students/' + id + '?access_token=' + localStorage.access_token,
        crossDomain: true,
        data: data,
        success: function(responseData, textStatus, jqXHR) {
          $(`#panic${id}`).removeClass('panic');
          alert('Alteração realizada com sucesso!');
        },
        error: function(responseData, textStatus, errorThrown) {
          alert('Algo deu errado' + JSON.stringify(responseData))
        }
      })
  }

  $(document).ready(function() {
    const curr = location.search.split("=")[1];
    $.ajax({
      url: url + 'courses/?filter={"include":"students"}&access_token=' + localStorage.access_token,
      crossDomain: true,
      success: function(res, textStatus, jqXHR) {
        courses = res;
        res.map((e, i) => {
          $('select#courses').append('<option value='+i+'>'+e.name+'</option>');
        });
        if (curr) {
          $('select#courses').val(curr);
          loadCourse(curr);
        }
      },
      error: function(responseData, textStatus, errorThrown) {
        console.log(responseData);;
      }
    })
  })

  </script>
</body>

</html>
