<!DOCTYPE html>
<html lang="pt" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="/css/master.css" />
    <link rel="stylesheet" href="/css/index.css" />
    <link rel="shortcut icon" href="assets/favicon.ico" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="./helper.js" charset="utf-8"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/simple-image@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/list@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/code@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@editorjs/inline-code@latest"></script>
    <title>Atividades</title>
  </head>

  <body>
    <main class="vertical">
      <a class="white_back" onclick="window.history.back();">
        &#11013;
      </a>
      <div id="selection">
        <h3>Selecionar curso:</h3>
        <select id="courses">
          <option disabled selected value></option>
        </select>
        <h3>Selecionar fase:</h3>
        <select id="levels">
          <option disabled selected value></option>
        </select>
      </div>
      <div id="level">
        <h2>ATIVIDADE</h2>
        <div class="row">
          <p>Título:</p>
          <input type="text" id="name" />
        </div>
        <div class="row">
          <p>Descrição:</p>
          <input type="text" id="description" size="60" />
        </div>
        <div class="row">
          <p>Nota mínima (%):</p>
          <input type="tel" id="minGrade" maxlength="4" />
        </div>
        <button class="finish" onclick="send()">SALVAR MUDANÇAS DA FASE</button>
        <h2>Exercícios</h2>
        <div id="exercises">
          <button class="exercise" onclick="addExercise()">+</button>
        </div>
        <div id="exerciseDetails" hidden>
          <div class="row">
            <p>Nome:</p>
            <input type="text" id="chapterName" />
          </div>
          <div class="row">
            <p>Caminho de submissão:</p>
            <input type="text" id="path" size="30" />
          </div>
          <h1>Texto do nível</h1>
          <div id="editorjs"></div>
          <h1>Testes</h1>
        </div>
      </div>
    </main>
    <script type="text/javascript">
      let courses;
      let course;
      let level;
      let exercise;

      const editor = new EditorJS({
        tools: {
          image: {
            class: SimpleImage,
            inlineToolbar: ['link'],
          },
          list: {
            class: List,
            inlineToolbar: true,
            shortcut: 'CMD+SHIFT+L',
          },
          code: {
            class: CodeTool,
            shortcut: 'CMD+SHIFT+C',
          },
        },
      });

      $('select#courses').on('change', function() {
        course = courses[this.value];
        courses[this.value].activities.forEach((e, i) => {
          $('select#levels').append(
            '<option value=' + i + '>' + i + ' - ' + e.levelName + '</option>',
          );
        });
      });

      $('select#levels').on('change', function() {
        level = course.activities[this.value];
        $('#minGrade').val(level.minGrade);
        $('#name').val(level.levelName);
        $('#description').val(level.levelDescription);
        $('#exercises').empty();
        $('#exercises').append(
          '<button class="exercise" onClick="addExercise">+</button>',
        );
        level.exercises.forEach((e, i) => {
          $('#exercises').prepend(
            `<button class="exercise" id="ex${i}Button" onClick=selectExercise(${i})>${i}</button>`,
          );
        });
      });

      function addExercise() {
        if (!level) {
          alert('Selecione uma fase primeiro!');
        }
      }
      function selectExercise(n) {
        if (exercise) {
          $(`#ex${exercise}Button`).removeClass('selected');
        }
        exercise = n;
        $(`#ex${n}Button`).addClass('selected');
        editor.blocks.clear();
        $('#exerciseDetails').show();
        let selectedExercise = level.exercises[n];
        $('#chapterName').val(selectedExercise.name);
        $('#path').val(selectedExercise.path);
      }

      $(document).ready(function() {
        $.ajax({
          url:
            url +
            'courses/?filter={"include":["students",{"activities": "exercises"}]}&access_token=' +
            localStorage.access_token,
          crossDomain: true,
          success: function(res, textStatus, jqXHR) {
            courses = res;
            res.map((e, i) => {
              $('select#courses').append(
                '<option value=' + i + '>' + e.name + '</option>',
              );
            });
          },
          error: function(responseData, textStatus, errorThrown) {
            console.log(responseData);
          },
        });
      });
    </script>
  </body>
</html>
